<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHub - Adaptive Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49C5'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen transition-colors">
    <!-- Navigation -->
    <nav class="bg-primary text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üìö EduHub</h1>
            <div class="flex space-x-4">
                <button id="practiceBtn" class="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30 transition-colors">Practice</button>
                <button id="tutorBtn" class="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30 transition-colors">AI Tutor</button>
                <button id="progressBtn" class="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30 transition-colors">Progress</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Subject Selection -->
        <div id="subjectSelection" class="mb-6">
            <h2 class="text-2xl font-bold mb-4">Choose Your Subject</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="subjectGrid">
                <!-- Subjects will be loaded here -->
            </div>
        </div>

        <!-- Topic Selection -->
        <div id="topicSelection" class="mb-6 hidden">
            <button id="backToSubjects" class="mb-4 text-primary hover:text-primary-dark">‚Üê Back to Subjects</button>
            <h2 class="text-2xl font-bold mb-4" id="selectedSubjectTitle"></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="topicGrid">
                <!-- Topics will be loaded here -->
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizInterface" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="backToTopics" class="text-primary hover:text-primary-dark">‚Üê Back to Topics</button>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                <div class="mb-4">
                    <span class="text-sm text-gray-600 dark:text-gray-400" id="questionMeta"></span>
                </div>
                <h3 class="text-lg font-medium mb-4" id="questionText"></h3>
                <div id="questionOptions" class="space-y-3"></div>
            </div>

            <div class="flex justify-between items-center">
                <button id="explainBtn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50" disabled>
                    ü§ñ Explain This
                </button>
                <div class="space-x-3">
                    <button id="prevBtn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" disabled>Previous</button>
                    <button id="nextBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors" disabled>Next</button>
                </div>
            </div>
        </div>

        <!-- AI Tutor Interface -->
        <div id="tutorInterface" class="hidden">
            <h2 class="text-2xl font-bold mb-4">ü§ñ AI Tutor</h2>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-4">
                <div id="tutorChat" class="space-y-4 mb-4 max-h-96 overflow-y-auto">
                    <div class="text-gray-600 dark:text-gray-400 text-center py-8">
                        Ask me anything about your studies! I can explain concepts, review your mistakes, or help with specific questions.
                    </div>
                </div>
                <div class="flex space-x-3">
                    <input type="text" id="tutorInput" class="flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ask your question here...">
                    <button id="sendTutorBtn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark transition-colors">Send</button>
                </div>
            </div>
        </div>

        <!-- Progress Interface -->
        <div id="progressInterface" class="hidden">
            <h2 class="text-2xl font-bold mb-4">üìä Your Progress</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                    <h3 class="font-bold mb-4">Overall Performance</h3>
                    <div id="overallStats"></div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                    <h3 class="font-bold mb-4">Subject Breakdown</h3>
                    <div id="subjectStats"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                <span>Loading questions...</span>
            </div>
        </div>
    </div>

    <script>
        // Sample question database structure (normally loaded from separate JSON files)
        // This demonstrates how meta.json would be structured for each subject
        const questionDatabase = {
            mathematics: {
                meta: { name: "Mathematics", icon: "üî¢", color: "bg-blue-500" },
                topics: {
                    numeration: {
                        name: "Numeration",
                        questions: [
                            {
                                id: "math-num-001",
                                question: "Convert 122‚ÇÑ (base 4) to base 10",
                                options: ["26", "30", "34", "38"],
                                answer: "A",
                                explanation: "122‚ÇÑ = 1√ó4¬≤ + 2√ó4¬π + 2√ó4‚Å∞ = 16 + 8 + 2 = 26",
                                difficulty: "medium",
                                source: "JAMB 2022",
                                skills: ["Base conversion", "Positional value"],
                                estimated_time: 30
                            },
                            {
                                id: "math-num-002",
                                question: "What is ¬≥‚ÅÑ‚Çà expressed as a decimal?",
                                options: ["0.375", "0.275", "0.475", "0.325"],
                                answer: "A",
                                explanation: "3 √∑ 8 = 0.375",
                                difficulty: "easy",
                                source: "WAEC 2021",
                                skills: ["Fraction to decimal", "Division"],
                                estimated_time: 20
                            }
                        ]
                    },
                    algebra: {
                        name: "Algebra",
                        questions: [
                            {
                                id: "math-alg-001",
                                question: "Solve for x: 2x + 5 = 13",
                                options: ["x = 4", "x = 5", "x = 6", "x = 9"],
                                answer: "A",
                                explanation: "2x + 5 = 13\n2x = 13 - 5\n2x = 8\nx = 4",
                                difficulty: "easy",
                                source: "Practice",
                                skills: ["Linear equations", "Solving for variable"],
                                estimated_time: 25
                            }
                        ]
                    }
                }
            },
            physics: {
                meta: { name: "Physics", icon: "‚öõÔ∏è", color: "bg-green-500" },
                topics: {
                    mechanics: {
                        name: "Mechanics",
                        questions: [
                            {
                                id: "phy-mech-001",
                                question: "A car accelerates from rest at 2 m/s¬≤. What is its velocity after 5 seconds?",
                                options: ["8 m/s", "10 m/s", "12 m/s", "15 m/s"],
                                answer: "B",
                                explanation: "Using v = u + at\nv = 0 + (2)(5) = 10 m/s",
                                difficulty: "medium",
                                source: "NECO 2022",
                                skills: ["Kinematics", "Acceleration"],
                                estimated_time: 40
                            }
                        ]
                    }
                }
            },
                        chemistry: {
                meta: { name: "Chemistry", icon: "‚öõÔ∏è", color: "bg-green-500" },
                topics: {
                    mechanics: {
                        name: "Mechanics",
                        questions: [
                            {
                                id: "che-air-001",
                                question: "A car accelerates from rest at 2 m/s¬≤. What is its velocity after 5 seconds?",
                                options: ["8 m/s", "10 m/s", "12 m/s", "15 m/s"],
                                answer: "B",
                                explanation: "Using v = u + at\nv = 0 + (2)(5) = 10 m/s",
                                difficulty: "medium",
                                source: "NECO 2022",
                                skills: ["Kinematics", "Acceleration"],
                                estimated_time: 40
                            }
                        ]
                    }
                }
            }
        };

        // User progress tracking (normally stored in database)
        let userProgress = {
            questionsAttempted: {},
            subjectStats: {},
            overallStats: { correct: 0, total: 0, timeSpent: 0 }
        };

        // Current state
        let currentSubject = null;
        let currentTopic = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswer = null;

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjects();
            setupEventListeners();
            setupAITutor();
        });

        function loadSubjects() {
            const subjectGrid = document.getElementById('subjectGrid');
            subjectGrid.innerHTML = '';

            Object.entries(questionDatabase).forEach(([key, subject]) => {
                const topicCount = Object.keys(subject.topics).length;
                const totalQuestions = Object.values(subject.topics).reduce((sum, topic) => sum + topic.questions.length, 0);
                
                const subjectCard = document.createElement('div');
                subjectCard.className = `${subject.meta.color} text-white p-6 rounded-lg cursor-pointer hover:opacity-90 transition-opacity`;
                subjectCard.innerHTML = `
                    <div class="text-3xl mb-2">${subject.meta.icon}</div>
                    <h3 class="text-xl font-bold mb-2">${subject.meta.name}</h3>
                    <p class="text-sm opacity-90">${topicCount} topics ‚Ä¢ ${totalQuestions} questions</p>
                `;
                subjectCard.onclick = () => selectSubject(key);
                subjectGrid.appendChild(subjectCard);
            });
        }

        function selectSubject(subjectKey) {
            currentSubject = subjectKey;
            const subject = questionDatabase[subjectKey];
            
            document.getElementById('subjectSelection').classList.add('hidden');
            document.getElementById('topicSelection').classList.remove('hidden');
            document.getElementById('selectedSubjectTitle').textContent = subject.meta.name;

            const topicGrid = document.getElementById('topicGrid');
            topicGrid.innerHTML = '';

            Object.entries(subject.topics).forEach(([key, topic]) => {
                const topicCard = document.createElement('div');
                topicCard.className = 'bg-gray-50 dark:bg-gray-800 p-6 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
                topicCard.innerHTML = `
                    <h3 class="text-lg font-bold mb-2">${topic.name}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${topic.questions.length} questions</p>
                `;
                topicCard.onclick = () => selectTopic(key);
                topicGrid.appendChild(topicCard);
            });
        }

        function selectTopic(topicKey) {
            currentTopic = topicKey;
            currentQuestions = [...questionDatabase[currentSubject].topics[topicKey].questions];
            currentQuestionIndex = 0;
            
            // Shuffle questions for variety
            currentQuestions.sort(() => Math.random() - 0.5);
            
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('quizInterface').classList.remove('hidden');
            
            loadQuestion();
        }

        function loadQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = currentQuestions.length;
            document.getElementById('questionMeta').textContent = `${question.difficulty} ‚Ä¢ ${question.source} ‚Ä¢ ~${question.estimated_time}s`;
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('questionOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('label');
                optionElement.className = 'flex items-center p-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors';
                optionElement.innerHTML = `
                    <input type="radio" name="answer" value="${String.fromCharCode(65 + index)}" class="mr-3">
                    <span>${option}</span>
                `;
                optionElement.querySelector('input').onchange = (e) => {
                    selectedAnswer = e.target.value;
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('explainBtn').disabled = false;
                };
                optionsContainer.appendChild(optionElement);
            });
            
            // Reset UI
            selectedAnswer = null;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('explainBtn').disabled = true;
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        }

        function setupEventListeners() {
            // Navigation
            document.getElementById('practiceBtn').onclick = () => showSection('subjectSelection');
            document.getElementById('tutorBtn').onclick = () => showSection('tutorInterface');
            document.getElementById('progressBtn').onclick = () => {
                showSection('progressInterface');
                loadProgress();
            };
            
            document.getElementById('backToSubjects').onclick = () => showSection('subjectSelection');
            document.getElementById('backToTopics').onclick = () => showSection('topicSelection');
            
            // Quiz navigation
            document.getElementById('nextBtn').onclick = () => {
                if (selectedAnswer) {
                    recordAnswer();
                    currentQuestionIndex++;
                    if (currentQuestionIndex < currentQuestions.length) {
                        loadQuestion();
                    } else {
                        finishQuiz();
                    }
                }
            };
            
            document.getElementById('prevBtn').onclick = () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion();
                }
            };
            
            document.getElementById('explainBtn').onclick = explainQuestion;
        }

        function setupAITutor() {
            const tutorInput = document.getElementById('tutorInput');
            const sendBtn = document.getElementById('sendTutorBtn');
            
            tutorInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendTutorMessage();
                }
            });
            
            sendBtn.onclick = sendTutorMessage;

            // Register AI response handler
            if (window.Poe) {
                window.Poe.registerHandler("tutor-handler", (result, context) => {
                    const msg = result.responses[0];
                    const chatContainer = document.getElementById('tutorChat');
                    let responseDiv = document.getElementById(`response-${context.messageId}`);
                    
                    if (!responseDiv) {
                        responseDiv = document.createElement('div');
                        responseDiv.id = `response-${context.messageId}`;
                        responseDiv.className = 'bg-blue-50 dark:bg-blue-900 p-4 rounded-lg';
                        responseDiv.innerHTML = `
                            <div class="font-medium text-blue-800 dark:text-blue-200 mb-2">ü§ñ AI Tutor</div>
                            <div class="response-content text-gray-700 dark:text-gray-300"></div>
                        `;
                        chatContainer.appendChild(responseDiv);
                    }
                    
                    const contentDiv = responseDiv.querySelector('.response-content');
                    
                    if (msg.status === "error") {
                        contentDiv.textContent = "Sorry, I encountered an error. Please try again.";
                    } else if (msg.status === "incomplete") {
                        contentDiv.innerHTML = marked.parse(msg.content);
                    } else if (msg.status === "complete") {
                        contentDiv.innerHTML = marked.parse(msg.content);
                    }
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
            }
        }

        async function sendTutorMessage() {
            const input = document.getElementById('tutorInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            const chatContainer = document.getElementById('tutorChat');
            const userDiv = document.createElement('div');
            userDiv.className = 'bg-gray-100 dark:bg-gray-700 p-4 rounded-lg';
            userDiv.innerHTML = `
                <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">üë§ You</div>
                <div class="text-gray-700 dark:text-gray-300">${message}</div>
            `;
            chatContainer.appendChild(userDiv);
            
            input.value = '';
            
            // Create context with current study session
            let context = `You are an educational AI tutor. The student is currently studying `;
            if (currentSubject && currentTopic) {
                const subjectName = questionDatabase[currentSubject].meta.name;
                const topicName = questionDatabase[currentSubject].topics[currentTopic].name;
                context += `${subjectName} - ${topicName}. `;
            }
            context += `Please provide helpful, encouraging responses. Student asks: ${message}`;
            
            if (window.Poe) {
                try {
                    await window.Poe.sendUserMessage(
                        `@Claude-Sonnet-4 ${context}`,
                        {
                            handler: "tutor-handler",
                            stream: true,
                            openChat: false,
                            handlerContext: { messageId: Date.now() }
                        }
                    );
                } catch (err) {
                    console.error('Error sending tutor message:', err);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-50 dark:bg-red-900 p-4 rounded-lg';
                    errorDiv.innerHTML = `
                        <div class="font-medium text-red-800 dark:text-red-200 mb-2">‚ùå Error</div>
                        <div class="text-red-700 dark:text-red-300">Unable to reach AI tutor. Please try again.</div>
                    `;
                    chatContainer.appendChild(errorDiv);
                }
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function explainQuestion() {
            if (!selectedAnswer) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.answer;
            
            const prompt = `Explain this ${questionDatabase[currentSubject].meta.name.toLowerCase()} question step by step:

Question: ${question.question}
Correct Answer: ${question.options[question.answer.charCodeAt(0) - 65]} (${question.answer})
Student's Answer: ${question.options[selectedAnswer.charCodeAt(0) - 65]} (${selectedAnswer})
Student was: ${isCorrect ? 'CORRECT' : 'INCORRECT'}

Explanation: ${question.explanation}

Please provide a clear, step-by-step explanation that helps the student understand the concept. If they were wrong, explain why their answer was incorrect and guide them to the right approach.`;

            if (window.Poe) {
                try {
                    await window.Poe.sendUserMessage(
                        `@Claude-Sonnet-4 ${prompt}`,
                        {
                            openChat: true
                        }
                    );
                } catch (err) {
                    console.error('Error getting explanation:', err);
                }
            }
        }

        function recordAnswer() {
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.answer;
            
            // Record attempt
            userProgress.questionsAttempted[question.id] = {
                correct: isCorrect,
                timeTaken: question.estimated_time, // In real app, track actual time
                attemptedAt: new Date().toISOString()
            };
            
            // Update stats
            userProgress.overallStats.total++;
            if (isCorrect) userProgress.overallStats.correct++;
            userProgress.overallStats.timeSpent += question.estimated_time;
            
            // Update subject stats
            if (!userProgress.subjectStats[currentSubject]) {
                userProgress.subjectStats[currentSubject] = { correct: 0, total: 0 };
            }
            userProgress.subjectStats[currentSubject].total++;
            if (isCorrect) userProgress.subjectStats[currentSubject].correct++;
        }

        function finishQuiz() {
            showCustomAlert(
                `Quiz Complete! üéâ\n\nYou answered ${userProgress.overallStats.correct} out of ${userProgress.overallStats.total} questions correctly.\n\nReady to try another topic?`,
                () => showSection('topicSelection')
            );
        }

        function loadProgress() {
            const overallDiv = document.getElementById('overallStats');
            const subjectDiv = document.getElementById('subjectStats');
            
            const accuracy = userProgress.overallStats.total > 0 
                ? Math.round((userProgress.overallStats.correct / userProgress.overallStats.total) * 100)
                : 0;
            
            overallDiv.innerHTML = `
                <div class="mb-3">
                    <div class="flex justify-between mb-1">
                        <span>Questions Answered</span>
                        <span class="font-bold">${userProgress.overallStats.total}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Accuracy</span>
                        <span class="font-bold">${accuracy}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Time Spent</span>
                        <span class="font-bold">${Math.round(userProgress.overallStats.timeSpent / 60)}m</span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                    <div class="bg-primary h-3 rounded-full transition-all duration-300" style="width: ${accuracy}%"></div>
                </div>
            `;
            
            subjectDiv.innerHTML = '';
            Object.entries(userProgress.subjectStats).forEach(([subject, stats]) => {
                const subjectAccuracy = Math.round((stats.correct / stats.total) * 100);
                const subjectName = questionDatabase[subject].meta.name;
                
                const statDiv = document.createElement('div');
                statDiv.className = 'mb-4';
                statDiv.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span>${subjectName}</span>
                        <span class="font-bold">${subjectAccuracy}%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="bg-${questionDatabase[subject].meta.color.split('-')[1]}-500 h-2 rounded-full" style="width: ${subjectAccuracy}%"></div>
                    </div>
                `;
                subjectDiv.appendChild(statDiv);
            });
        }

        function showSection(sectionId) {
            ['subjectSelection', 'topicSelection', 'quizInterface', 'tutorInterface', 'progressInterface'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showCustomAlert(message, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4 whitespace-pre-line">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors" onclick="this.closest('.fixed').remove(); ${callback ? 'callback()' : ''}">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            if (callback) {
                modal.querySelector('button').onclick = () => {
                    modal.remove();
                    callback();
                };
            }
        }
    </script>
</body>
</html>